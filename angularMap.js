!function(root,factory){"function"==typeof define&&define.amd?define("angular-map",["angular"],factory):"object"==typeof exports?module.exports=factory(require("angular")):factory(angular)}(this,function(angular){angular.module("angularMap",[])});var module=angular.module("angularMap");module.factory("mapFactory",function(mapApiService,defaults){var _extend=function(defOpt,opt,res,deep){if(2===arguments.length)return res={},opt=opt||{},_extend(defOpt,opt,res,10),res;if(4===arguments.length){if(--deep<0)return;for(k in defOpt)opt&&opt[k]?res[k]=opt[k]:res[k]=defOpt[k],res[k]&&opt&&defOpt&&_extend(defOpt[k],opt[k],res[k])}},_createMap=function(options){return options=_extend(defaults.MAP_OPTIONS,options),options.mapElement?L.map(options.mapElement).setView(options.center||defaults.MAP_CENTER,options.zoom||defaults.MAP_ZOOM):null},_createMarker=function(options){options=_extend(defaults.MARKER_OPTIONS,options);var marker=L.marker(JSON.parse(JSON.stringify(options.position)),{draggable:!!options.draggable});return options.info&&marker.bindPopup(options.info),marker},_createPolyline=function(options){options=_extend(defaults.POLYLINE_OPTIONS,options);var polyline=L.polyline(options.path,{color:options.color});return options.info&&polyline.bindPopup(options.info),polyline};return{createMap:_createMap,createMarker:_createMarker,createPolyline:_createPolyline}});var module=angular.module("angularMap");module.service("mapApiService",function(layerProviders){this.getLayer=function(provider){return provider.startsWith(layerProviders.GOOGLE)?L.gridLayer.googleMutant():L.tileLayer.provider(provider)}}),angular.module("angularMap").value("defaults",{MAP_OPTIONS:{mapElement:null,center:[-5.3062885,-39.3806493],zoom:4},MARKER_OPTIONS:{position:[-5.3062885,-39.3806493],info:null,draggable:!1},POLYLINE_OPTIONS:{path:[[-5.3062885,-39.3806493],[-6.3062885,-40.3806493]],color:"#9C27B0"}}),angular.module("angularMap").value("layerProviders",{GOOGLE:"GoogleMap",OPEN_STREET_MAP:"OpenStreetMap",OPEN_STREET_MAP_BACK_AND_WHITE:"OpenStreetMap.BlackAndWhite"}),angular.module("angularMap").directive("map",function(mapFactory){return{template:"<div ng-transclude></div>",replace:!0,restrict:"AE",transclude:!0,scope:{tileLayer:"=",center:"=",zoom:"="},controller:function($scope){$scope.listeners=[],this.getMap=function(callback){$scope.map?callback($scope.map):$scope.listeners.push(callback)},$scope.$watch("tileLayer",function(old,newest){old.remove(),newest.addTo($scope.map)})},link:function(scope,element,attrs,controller,transcludeFn){console.log("MAP"),scope.map=mapFactory.createMap({mapElement:element[0],center:scope.center,zoom:scope.zoom}),scope.tileLayer.addTo(scope.map),scope.listeners.map(function(l){l(scope.map)})}}}),angular.module("angularMap").directive("marker",function(mapFactory){return{template:"",replace:!0,restrict:"AE",transclude:!1,scope:{position:"=",info:"=",draggable:"="},controller:function($scope){$scope.$watch("position",function(){var latlng={lat:parseFloat($scope.position[0]),lng:parseFloat($scope.position[1])};$scope.marker.setLatLng(latlng)},!0),$scope.$on("$destroy",function(){$scope.map.removeLayer($scope.marker)})},require:"^map",link:function(scope,element,attrs,controller,transcludeFn){console.log("Marker"),controller.getMap(function(map){scope.map=map,scope.marker=mapFactory.createMarker(scope),scope.marker.addTo(scope.map),scope.marker.on("drag",function(e){scope.position[0]=scope.marker.getLatLng().lat,scope.position[1]=scope.marker.getLatLng().lng,scope.$apply()})})}}});